<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze Game Controller</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(8, 40px);
            grid-template-rows: repeat(8, 40px);
            gap: 2px;
            margin: 20px auto;
            width: 330px;
        }
        
        .cell {
            width: 40px;
            height: 40px;
            background-color: #eee;
            border: 1px solid #ccc;
        }
        
        .wall {
            background-color: #333;
        }
        
        .path {
            background-color: #fff;
        }
        
        .player {
            background-color: #00ff00;
            border-radius: 50%;
        }
        
        .exit {
            background-color: #ff0000;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .arrows {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            margin: 10px 0;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .arrow-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            font-weight: bold;
        }
        
        #status {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            min-height: 20px;
        }
    </style>
</head>
<body>
    <h1>Maze Game</h1>
    
    <div class="controls">
        <button id="connectBtn">Connect Arduino</button>
        <button id="newMazeBtn">New Maze</button>
    </div>
    
    <div id="status">Not connected</div>
    
    <div class="grid" id="mazeGrid"></div>
    
    <div class="controls">
        <div class="arrows">
            <div></div>
            <button class="arrow-btn" id="upBtn">↑</button>
            <div></div>
            <button class="arrow-btn" id="leftBtn">←</button>
            <div></div>
            <button class="arrow-btn" id="rightBtn">→</button>
            <div></div>
            <button class="arrow-btn" id="downBtn">↓</button>
            <div></div>
        </div>
    </div>

    <script>
        // Game state
        const maze = [
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 0, 0, 1, 0, 1, 0],
            [0, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 0, 0, 1, 0, 1, 0],
            [0, 1, 1, 1, 1, 0, 1, 0],
            [0, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 0, 0, 0, 0, 0, 0]
        ];
        
        let playerX = 1;
        let playerY = 1;
        const exitX = 6;
        const exitY = 6;
        
        // Web Serial variables
        let port;
        let reader;
        let writer;
        let readLoopRunning = false;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const newMazeBtn = document.getElementById('newMazeBtn');
        const mazeGrid = document.getElementById('mazeGrid');
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        
        // Create the maze grid
        function createMazeGrid() {
            mazeGrid.innerHTML = '';
            
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    if (x === playerX && y === playerY) {
                        cell.classList.add('player');
                    } else if (x === exitX && y === exitY) {
                        cell.classList.add('exit');
                    } else if (maze[y][x] === 0) {
                        cell.classList.add('wall');
                    } else {
                        cell.classList.add('path');
                    }
                    
                    mazeGrid.appendChild(cell);
                }
            }
        }
        
        // Update player position
        function updatePlayerPosition() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => cell.classList.remove('player'));
            
            const playerCell = cells[playerY * 8 + playerX];
            if (playerCell) {
                playerCell.classList.add('player');
            }
        }
        
        // Move player
        function movePlayer(direction) {
            if (!writer) {
                statusEl.textContent = 'Not connected to Arduino';
                return;
            }
            
            const encoder = new TextEncoder();
            writer.write(encoder.encode(`MOVE:${direction}\n`));
            statusEl.textContent = `Sent command: MOVE:${direction}`;
        }
        
        // Connect to Arduino
        async function connectArduino() {
            try {
                // Check if Web Serial API is supported
                if (!navigator.serial) {
                    statusEl.textContent = 'Web Serial API not supported. Use Chrome or Edge.';
                    return;
                }
                
                // Request port access
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                // Set up writer
                writer = port.writable.getWriter();
                
                // Set up reader
                startReadLoop();
                
                statusEl.textContent = 'Connected to Arduino';
                connectBtn.textContent = 'Disconnect';
                
                // Send ping to verify connection
                const encoder = new TextEncoder();
                writer.write(encoder.encode("PING\n"));
            } catch (error) {
                statusEl.textContent = `Error: ${error.message}`;
                console.error(error);
            }
        }
        
        // Start reading from Arduino
        async function startReadLoop() {
            if (readLoopRunning) return;
            
            readLoopRunning = true;
            
            while (port && port.readable && readLoopRunning) {
                reader = port.readable.getReader();
                
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        
                        if (done) {
                            break;
                        }
                        
                        // Process incoming data
                        const text = new TextDecoder().decode(value);
                        processArduinoData(text);
                    }
                } catch (error) {
                    console.error('Error reading from Arduino:', error);
                } finally {
                    reader.releaseLock();
                }
            }
            
            readLoopRunning = false;
        }
        
        // Process data from Arduino
        function processArduinoData(data) {
            console.log('From Arduino:', data);
            
            const lines = data.split('\n');
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                if (line.startsWith('READY:')) {
                    statusEl.textContent = 'Arduino is ready';
                }
                else if (line.startsWith('POS:')) {
                    const pos = line.substring(4).split(',');
                    if (pos.length === 2) {
                        playerX = parseInt(pos[0]);
                        playerY = parseInt(pos[1]);
                        updatePlayerPosition();
                    }
                }
                else if (line.startsWith('WIN:')) {
                    statusEl.textContent = 'You won! Player has been reset.';
                    playerX = 1;
                    playerY = 1;
                    updatePlayerPosition();
                }
                else if (line.startsWith('PONG')) {
                    statusEl.textContent = 'Arduino connection verified';
                }
            }
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connectArduino);
        newMazeBtn.addEventListener('click', createMazeGrid);
        
        upBtn.addEventListener('click', () => movePlayer('UP'));
        downBtn.addEventListener('click', () => movePlayer('DOWN'));
        leftBtn.addEventListener('click', () => movePlayer('LEFT'));
        rightBtn.addEventListener('click', () => movePlayer('RIGHT'));
        
        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'ArrowUp':
                    movePlayer('UP');
                    break;
                case 'ArrowDown':
                    movePlayer('DOWN');
                    break;
                case 'ArrowLeft':
                    movePlayer('LEFT');
                    break;
                case 'ArrowRight':
                    movePlayer('RIGHT');
                    break;
            }
        });
        
        // Initialize
        createMazeGrid();
    </script>
</body>
</html>
